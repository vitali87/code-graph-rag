name: Auto Review Comments

on:
  pull_request_target:
    types: [opened, synchronize]

concurrency:
  group: auto-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  post-review-comments:
    runs-on: ubuntu-latest
    if: github.actor != 'dependabot[bot]' && github.actor != 'github-actions[bot]'
    permissions:
      pull-requests: write
    steps:
      # (H) Checks ALL unresolved threads (human + bot) to ensure reviews only
      # trigger after the author has addressed all feedback from any reviewer.
      - name: Check for unresolved review threads
        id: check-threads
        if: github.event.action == 'synchronize'
        uses: actions/github-script@v7
        with:
          script: |
            const query = `
              query($owner: String!, $repo: String!, $number: Int!, $cursor: String) {
                repository(owner: $owner, name: $repo) {
                  pullRequest(number: $number) {
                    reviewThreads(first: 100, after: $cursor) {
                      pageInfo {
                        hasNextPage
                        endCursor
                      }
                      nodes {
                        isResolved
                      }
                    }
                  }
                }
              }
            `;
            try {
              let hasNextPage = true;
              let cursor = null;
              let unresolvedCount = 0;
              let totalThreads = 0;

              while (hasNextPage) {
                const result = await github.graphql(query, {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  number: context.payload.pull_request.number,
                  cursor: cursor
                });
                const threads = result.repository.pullRequest.reviewThreads;
                totalThreads += threads.nodes.length;
                unresolvedCount += threads.nodes.filter(t => !t.isResolved).length;
                hasNextPage = threads.pageInfo.hasNextPage;
                cursor = threads.pageInfo.endCursor;
              }

              console.log(`Found ${totalThreads} review threads, ${unresolvedCount} unresolved`);
              core.setOutput('has_unresolved', unresolvedCount > 0);
            } catch (error) {
              core.warning(`Failed to check review threads: ${error.message}. Skipping review triggers.`);
              core.setOutput('has_unresolved', true);
            }

      - name: Delete old trigger comments and post new ones
        if: github.event.action == 'opened' || steps.check-threads.outputs.has_unresolved == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const triggers = ['/gemini review', '@greptile'];

            try {
              let page = 1;
              let allComments = [];

              while (true) {
                const response = await github.rest.issues.listComments({
                  owner,
                  repo,
                  issue_number: prNumber,
                  per_page: 100,
                  page: page
                });
                allComments = allComments.concat(response.data);
                if (response.data.length < 100) break;
                page++;
              }

              for (const comment of allComments) {
                const body = comment.body.trim();
                if (triggers.includes(body) && comment.user.login === 'github-actions[bot]') {
                  console.log(`Deleting old trigger comment: ${body} (id: ${comment.id})`);
                  await github.rest.issues.deleteComment({
                    owner,
                    repo,
                    comment_id: comment.id
                  });
                }
              }

              for (const trigger of triggers) {
                console.log(`Posting: ${trigger}`);
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: prNumber,
                  body: trigger
                });
              }

              console.log('Successfully posted review trigger comments');
            } catch (error) {
              core.setFailed(`Failed to manage comments: ${error.message}`);
            }
