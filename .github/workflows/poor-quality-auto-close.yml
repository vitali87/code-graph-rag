name: Auto-close Poor Quality PRs

on:
  schedule:
    - cron: '0 9 * * *'
  workflow_dispatch:

jobs:
  close-stale-poor-quality-prs:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
    steps:
      - name: Close PRs with poor-quality label older than 7 days
        uses: actions/github-script@v7
        with:
          script: |
            const LABEL_NAME = 'poor-quality';
            const DAYS_THRESHOLD = 7;
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - DAYS_THRESHOLD);

            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            for (const pr of prs) {
              const hasLabel = pr.labels.some(label => label.name === LABEL_NAME);
              if (!hasLabel) continue;

              const { data: events } = await github.rest.issues.listEvents({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                per_page: 100
              });

              const labelEvent = events
                .filter(e => e.event === 'labeled' && e.label?.name === LABEL_NAME)
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];

              if (!labelEvent) continue;

              const labeledAt = new Date(labelEvent.created_at);
              if (labeledAt > cutoffDate) continue;

              console.log(`Closing PR #${pr.number} - labeled on ${labeledAt.toISOString()}`);

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `ðŸš« **This PR has been automatically closed.**\n\nIt was marked as \`poor-quality\` more than 7 days ago and was not updated to meet contribution standards.\n\nFeel free to open a new PR if you'd like to revisit this contribution.`
              });

              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                state: 'closed'
              });
            }
